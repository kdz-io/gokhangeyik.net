<!DOCTYPE html>
<html lang="tr">
<head>

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>Ghost ve NGINX Proxy Cache</title>
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" type="text/css" href="/assets/built/screen.css?v=d315fa5c26" />
    <meta name="description" content="Ghost, bir içerik yönetim sistemi. Modern ve oldukça hızlı. Benim için en büyük cazibesi ise Markdown ile makale yazabilme kolaylığı.">
    <link rel="icon" href="https://www.gokhangeyik.net/content/images/size/w256h256/2021/01/header_logo.png" type="image/png">
    <link rel="canonical" href="https://www.gokhangeyik.net/ghost-ve-nginx-proxy-cache/">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <link rel="amphtml" href="https://www.gokhangeyik.net/ghost-ve-nginx-proxy-cache/amp/">
    
    <meta property="og:site_name" content="Gökhan Geyik | Sistem Yöneticisi Bir Bey!">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Ghost ve NGINX Proxy Cache">
    <meta property="og:description" content="Ghost, bir içerik yönetim sistemi. Modern ve oldukça hızlı. Benim için en büyük cazibesi ise Markdown ile makale yazabilme kolaylığı.">
    <meta property="og:url" content="https://www.gokhangeyik.net/ghost-ve-nginx-proxy-cache/">
    <meta property="og:image" content="https://www.gokhangeyik.net/content/images/2021/01/ghost-nginx-proxy.jpg">
    <meta property="article:published_time" content="2021-01-10T11:15:00.000Z">
    <meta property="article:modified_time" content="2021-01-22T10:12:52.000Z">
    <meta property="article:tag" content="Ghost">
    <meta property="article:tag" content="Nginx">
    <meta property="article:tag" content="OS">
    
    <meta property="article:publisher" content="https://www.facebook.com/gokhangeyik.net">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Ghost ve NGINX Proxy Cache">
    <meta name="twitter:description" content="Ghost, bir içerik yönetim sistemi. Modern ve oldukça hızlı. Benim için en büyük cazibesi ise Markdown ile makale yazabilme kolaylığı.">
    <meta name="twitter:url" content="https://www.gokhangeyik.net/ghost-ve-nginx-proxy-cache/">
    <meta name="twitter:image" content="https://www.gokhangeyik.net/content/images/2021/01/ghost-nginx-proxy.jpg">
    <meta name="twitter:label1" content="Written by">
    <meta name="twitter:data1" content="Gökhan Geyik">
    <meta name="twitter:label2" content="Filed under">
    <meta name="twitter:data2" content="Ghost, Nginx, OS">
    <meta name="twitter:site" content="@gokhangeyiknet">
    <meta name="twitter:creator" content="@gokko">
    <meta property="og:image:width" content="2000">
    <meta property="og:image:height" content="1125">
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Gökhan Geyik | Sistem Yöneticisi Bir Bey!",
        "url": "https://www.gokhangeyik.net/",
        "logo": {
            "@type": "ImageObject",
            "url": "https://www.gokhangeyik.net/content/images/2021/01/logo.svg",
            "width": 60,
            "height": 60
        }
    },
    "author": {
        "@type": "Person",
        "name": "Gökhan Geyik",
        "image": {
            "@type": "ImageObject",
            "url": "https://www.gokhangeyik.net/content/images/2021/01/pp.jpg",
            "width": 1588,
            "height": 1588
        },
        "url": "https://www.gokhangeyik.net/author/gokko/",
        "sameAs": [
            "https://www.gokhangeyik.net",
            "https://twitter.com/gokko"
        ]
    },
    "headline": "Ghost ve NGINX Proxy Cache",
    "url": "https://www.gokhangeyik.net/ghost-ve-nginx-proxy-cache/",
    "datePublished": "2021-01-10T11:15:00.000Z",
    "dateModified": "2021-01-22T10:12:52.000Z",
    "image": {
        "@type": "ImageObject",
        "url": "https://www.gokhangeyik.net/content/images/2021/01/ghost-nginx-proxy.jpg",
        "width": 2000,
        "height": 1125
    },
    "keywords": "Ghost, Nginx, OS",
    "description": "Ghost, bir içerik yönetim sistemi. Modern ve oldukça hızlı. Benim için en büyük cazibesi ise Markdown ile makale yazabilme kolaylığı.",
    "mainEntityOfPage": "https://www.gokhangeyik.net/ghost-ve-nginx-proxy-cache/"
}
    </script>

    <meta name="generator" content="Ghost 5.49">
    <link rel="alternate" type="application/rss+xml" title="Gökhan Geyik | Sistem Yöneticisi Bir Bey!" href="https://www.gokhangeyik.net/rss/">
    
    <script defer src="https://cdn.jsdelivr.net/ghost/sodo-search@~1.1/umd/sodo-search.min.js" data-key="e9e6e512dc0d34c1f08c1f3ddc" data-styles="https://cdn.jsdelivr.net/ghost/sodo-search@~1.1/umd/main.css" data-sodo-search="https://www.gokhangeyik.net/" crossorigin="anonymous"></script>
    
    <link href="https://www.gokhangeyik.net/webmentions/receive/" rel="webmention">
    <script defer src="/public/cards.min.js?v=d315fa5c26"></script>
    <link rel="stylesheet" type="text/css" href="/public/cards.min.css?v=d315fa5c26">
    <meta name="yandex-verification" content="cbc27cc1459354e5" />
<meta name="google-site-verification" content="LopKNmsIP8jLGP9JJqHGqQ1oBsLw898eIKxb0VoDM64" />
<script>document.documentElement.classList.add('dark-mode');</script><style>:root {--ghost-accent-color: #1a1b20;}</style>
    <link rel="stylesheet" type="text/css" href="/assets/built/prism.css?v=d315fa5c26" media="print" onload="this.media='all'" />

</head>
<body class="post-template tag-ghost-tag tag-nginx tag-os">

    <div class="site-wrapper">

        
<header class="site-header">
    <div class="outer site-nav-main">
    <div class="inner">
        <nav class="site-nav">
    <div class="site-nav-left-wrapper">
        <div class="site-nav-left">
                <a class="site-nav-logo" href="https://www.gokhangeyik.net"><img src="https://www.gokhangeyik.net/content/images/2021/01/logo.svg" alt="Gökhan Geyik | Sistem Yöneticisi Bir Bey!" /></a>
            <div class="site-nav-content">
                    <ul class="nav">
    <li class="nav-isletim-sistemleri"><a href="https://www.gokhangeyik.net/tag/os/">İşletim Sistemleri</a></li>
    <li class="nav-programlama"><a href="https://www.gokhangeyik.net/tag/coding/">Programlama</a></li>
    <li class="nav-hayat"><a href="https://www.gokhangeyik.net/tag/hayat/">Hayat</a></li>
</ul>

                    <span class="nav-post-title ">Ghost ve NGINX Proxy Cache</span>
            </div>
        </div>
    </div>
    <div class="site-nav-right">
            <div class="social-links">
                    <a class="social-link social-link-fb" href="https://www.facebook.com/gokhangeyik.net" title="Facebook" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!-- Font Awesome Free 5.15.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M279.14 288l14.22-92.66h-88.91v-60.13c0-25.35 12.42-50.06 52.24-50.06h40.42V6.26S260.43 0 225.36 0c-73.22 0-121.08 44.38-121.08 124.72v70.62H22.89V288h81.39v224h100.17V288z"/></svg></a>
                    <a class="social-link social-link-tw" href="https://twitter.com/gokhangeyiknet" title="Twitter" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg></a>
                    <a class="social-link social-link-tw" href="https://www.linkedin.com/in/gokhangeyik/" title="Linkedin" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M100.28 448H7.4V148.9h92.88zM53.79 108.1C24.09 108.1 0 83.5 0 53.8a53.79 53.79 0 0 1 107.58 0c0 29.7-24.1 54.3-53.79 54.3zM447.9 448h-92.68V302.4c0-34.7-.7-79.2-48.29-79.2-48.29 0-55.69 37.7-55.69 76.7V448h-92.78V148.9h89.08v40.8h1.3c12.4-23.5 42.69-48.3 87.88-48.3 94 0 111.28 61.9 111.28 142.3V448z"/></svg></a>
            </div>

    </div>
</nav>
    </div>
</div></header>
<main id="site-main" class="site-main outer">
    <div class="inner">
        <article class="post-full post tag-ghost-tag tag-nginx tag-os featured ">

            <header class="post-full-header">

                <section class="post-full-tags">
                    <a href="/tag/ghost-tag/">Ghost</a>
                </section>

                <h1 class="post-full-title">Ghost ve NGINX Proxy Cache</h1>

                <p class="post-full-custom-excerpt">Ghost, bir içerik yönetim sistemi. Modern ve oldukça hızlı. Benim için en büyük cazibesi ise Markdown ile makale yazabilme kolaylığı.</p>

                <div class="post-full-byline">

                    <section class="post-full-byline-content">

                        <ul class="author-list">
                            <li class="author-list-item">

                                <div class="author-card">
                                    <img class="author-profile-image" src="/content/images/size/w300/2021/01/pp.jpg" alt="Gökhan Geyik" />
                                    <div class="author-info">
                                        <div class="bio">
                                            <h2>Gökhan Geyik</h2>
                                            <p>1995&#x27;ten bu yana her gün bilgisayar klavyesine dokunuyorum. 2001&#x27;den itibaren bu davranışım yüzünden para kazanıyorum.</p>
                                            <p><a href="/author/gokko/">More posts</a> by Gökhan Geyik.</p>
                                        </div>
                                    </div>
                                </div>

                                <a href="/author/gokko/" class="author-avatar">
                                    <img class="author-profile-image" src="/content/images/size/w300/2021/01/pp.jpg" alt="Gökhan Geyik" />
                                </a>

                            </li>
                        </ul>

                        <section class="post-full-byline-meta">
                            <h4 class="author-name"><a href="/author/gokko/">Gökhan Geyik</a></h4>
                            <div class="byline-meta-content">
                                <time class="byline-meta-date" datetime="2021-01-10">10 Ocak 2021 12:15</time>
                            </div>
                        </section>

                    </section>
                </div>
            </header>

            <figure class="post-full-image">
                <img
                    srcset="/content/images/size/w300/2021/01/ghost-nginx-proxy.jpg 300w,
                            /content/images/size/w600/2021/01/ghost-nginx-proxy.jpg 600w,
                            /content/images/size/w1000/2021/01/ghost-nginx-proxy.jpg 1000w,
                            /content/images/size/w2000/2021/01/ghost-nginx-proxy.jpg 2000w"
                    sizes="(max-width: 800px) 400px,
                        (max-width: 1170px) 1170px,
                            2000px"
                    src="/content/images/size/w600/2021/01/ghost-nginx-proxy.jpg"
                    alt="Ghost ve NGINX Proxy Cache"
                />
            </figure>
            <section class="post-full-content">
                <div class="post-content">
                    <p><a href="https://github.com/TryGhost/Ghost?ref=localhost"><strong>Ghost</strong></a>, bir içerik yönetim sistemi. Modern ve oldukça hızlı. Benim için en büyük cazibesi ise <a href="https://en.wikipedia.org/wiki/Markdown?ref=localhost">Markdown</a> ile makale yazabilme kolaylığı.</p><p>Uzun zamandır bir arayışın içindeydim. Wordpress artık beni bunaltmaya başladı çünkü bir çok temel eksiklikleri mevcut. Bunları tamamlamak için pluginler deryasında boğulmaktan kaçamıyorsunuz. <a href="https://en.wikipedia.org/wiki/Qmail?ref=localhost">Qmail</a> <a href="https://notes.sagredo.eu/en/qmail-notes-185/patching-qmail-82.html?ref=localhost">patch çılgınlığı</a> gibi...</p><p>Basit, hızlı, hafif ve kolay kullanılabilir bir şeye ihtiyacım vardı. <a href="https://getgrav.org/?ref=localhost">Grav</a> ilk durağım oldu ve işin doğrusu hoşuma da gitti. Üzerinde epeyce zaman harcadım ve hatta bir süre sitemi yayınladım. Neticede kendisi ile de yollarımızı ayırdık malesef. Çok detaya girmek istemiyorum.</p><p>Ghost hali hazırda zaten oldukça hızlı çalışan bir <a href="https://en.wikipedia.org/wiki/Content_management_system?ref=localhost">CMS</a>. Fakat <a href="https://expressjs.com/?ref=localhost">Express'i</a> olduğu gibi yayınlamak fikrine pek sıcak bakmıyorum. Bu nedenle önüne bir NGINX yerleştirmeye karar verdim.</p><p>Bu sayede <a href="http://nginx.org/?ref=localhost">NGINX</a> ile bir çok numara yapabilirim. Proxy Cache de bunlardan yalnızca bir tanesi.</p><p>Proxy Cache ile tüm çıktıyı cacheleyeceğim ve böylelikle arkadaki Ghost servisini bir nevi maskelemiş olacağım. Ayrıca Lua ve Ghost'un Webhooklarını kullanarak, sitede değişikiller oldukça, cachein tazelenmesini de sağlayacağım.</p><p>Tüm yaptıklarımı adım adım anlatacağı ancak bir parça NGINX biliyor olmak işi kolaylaştıracaktır.</p><h2 id="altyap-senaryosu">Altyapı Senaryosu</h2><p>Elimde bir <strong>Ghost</strong> olacak ve <code>https://www.gokhangeyik.net</code> ile erişebileceğim. Ancak önünde bir <strong>NGINX</strong> olacak ve ilk olarak trafiği karşılayacak. İsteğe bağlı olarak, Ghost backend ne cevap verirse, ziyaretçiye iletirken aynı zamanda da bir sonraki istekler için 2 saat boyunca cache yapacak.</p><p>Cache purge için son derece basit bir Lua script kullanacağım. Çünkü sitenin içeriği güncellendiğinde tüm cache içeriğinin temizlenmesi büyük bir problem değil. Ancak daha kompleks purge isteklerini elbette kendiniz de yazabilirsiniz. Tabi bu minvalde kendi webhooklarınızı düzenlemeniz gerekir.</p><h2 id="kuruluma-ba-layal-m">Kuruluma Başlayalım</h2><p>Tüm bunlar için Docker kullanacağım. Ancak bu bare metal kurulum yapanlar için de bir fark yaratmaz. Neticede odaklandığımız konu NGINX ve Ghost olacak.</p><h3 id="ghost-kurulumu">Ghost Kurulumu</h3><pre><code class="language-plaintext">docker run --name ghost -p 2368:2368 ghost:3-alpine</code></pre><p>Ghost ilk kez çalıştığı için, gerek duyduğu bir takım işlemler gerçekleştirecek ve neticede <code>https://www.gokhangeyik.net</code>erişilebilir hale gelecek.</p><p>Bunu <code>curl</code>ile test edebiliriz.</p><pre><code class="language-plaintext">➜ curl -I https://www.gokhangeyik.net
HTTP/1.1 200 OK
X-Powered-By: Express
Cache-Control: public, max-age=0
Content-Type: text/html; charset=utf-8
Content-Length: 29518
ETag: W/"734e-9ZdP5ZYyAQqraAJyQref33AByfQ"
Vary: Accept-Encoding
Date: Wed, 06 Jan 2021 21:16:43 GMT
Connection: keep-alive
Keep-Alive: timeout=5</code></pre><p>Ghost çalışıyor ve isteklere yanıt veriyor. Artık devam edebiliriz.</p><h3 id="nginx-kurulumu">NGINX Kurulumu</h3><p>Bunun için de Docker kullanacağım. Basit tutmak için, contaier temelini Alpine tercih ediyorum. </p><pre><code class="language-plaintext">docker run --name nginx --rm -it -p 80:80 alpine:latest sh</code></pre><p>Artık bir Alpine containerım var ve gerekli paketleri kurabilirim. İhtiyacım olan paketler:</p><ul><li>nginx</li><li>nginx-mod-http-lua</li><li>lua-resty-core</li></ul><pre><code class="language-plaintext">apk update
apk add --no-cache nginx nginx-mod-http-lua lua-resty-core</code></pre><p>Amacıma ulaşmaya hemen hemen hazırım ancak burada kısa bir bilgi vermem gerekiyor. Herşeyi cache etmek akıllıca olmayacaktır. Çünkü Ghost'un bazı lokasyonları tam tersine cache edilmemeli. Çünkü bu lokasyonlar, giriş yapmış kullanıcılara ait araçları içeriyor. Burada <code><a href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html?ref=localhost">proxy_cache_bypass</a></code> kullanabilirdim ve cookie bunun için harika bir belirleyici olabilirdi, ancak ben biraz daha net olmak istiyorum ve bu nedenle <code><a href="http://nginx.org/en/docs/http/ngx_http_core_module.html?ref=localhost#location">location</a></code> konteksti ile bu özel alanları ayrı tutacağım.</p><pre><code class="language-nginx">proxy_cache_path /var/cache/nginx/ levels=1:2 keys_zone=ghost_cache:10m max_size=512m inactive=2h;
proxy_cache_key "$request_method$host$request_uri";
proxy_cache_methods GET HEAD;</code></pre><p>Yukarıdaki direktifler <code>http</code> kontekstinin içinde olmalı. Şimdi tek tek ne yaptığımı anlatacağım.</p><p><code>proxy_cache_path</code>, yapacağım işlem için oldukça kritik. Cache edilmiş isteklere ait dosyaların, nerede, ne şekilde ve ne kadar süreyle tutulmasını istediğimi belirtebilmemi sağlar. Ayrıca bu dosyaların byte cinsinden kaplayabileceği en fazla alanı da limitleyebilirim.</p><p>Örneğimden gidecek olursam, cache istekleri <code>/var/cache/nginx</code> dizininde depolanacak.</p><p><code>level=1:2</code> ise bu cache çıktılarının hiyerarşik olarak düzenini belirtiyor. NGINX, cache çıktılarını <code><a href="https://en.wikipedia.org/wiki/MD5?ref=localhost">MD5</a></code> ile isimlendirir. Yani günün sonunda aşağıdaki gibi dosya isimlerine sahip olacağım.</p><figure class="kg-card kg-code-card"><pre><code class="language-plaintext">bash-5.1# ls -Al
total 32
drwx------    3 nginx    nginx         4096 Jan 10 08:40 3
drwx------    3 nginx    nginx         4096 Jan 10 08:41 4
drwx------    3 nginx    nginx         4096 Jan 10 08:40 6
drwx------    4 nginx    nginx         4096 Jan 10 08:41 8
drwx------    3 nginx    nginx         4096 Jan 10 08:40 9
drwx------    3 nginx    nginx         4096 Jan 10 08:40 d
drwx------    3 nginx    nginx         4096 Jan 10 08:41 e
drwx------    3 nginx    nginx         4096 Jan 10 08:40 f</code></pre><figcaption>/var/cache/nginx</figcaption></figure><p>Örnek olarak <code>8</code> dizininin içeriğine bakalım.</p><pre><code class="language-plaintext">bash-5.1# cd /var/cache/nginx/8/
bash-5.1# find .
.
./ca
./ca/31b4504a91cc38c996e2dff211e59ca8
./2e
./2e/b999904f61cd8ade87149edef72dd2e8</code></pre><p>Yani NGINX, oluşturduğu bu dosya isimlerinden sonran 1. karakteri ilk seviye dizin olarak oluşturuyor. Bundan sonra gelen 2 karakteri de -<em>ki bizim çıktımızda bu <code>ca</code> ve <code>2e</code></em>- bir alt dizin olarak oluşturup, cache çıktısını burada saklıyor.</p><p><code>keys_zone</code> bir çeşit index olarak düşünülebilir. Cache dosyalarının anahtarları burada tutuluyor. NGINX dökümanına göre 1 Mbyte boyutundan bir zone 8.000 anahtar saklayabiliyor. Aslında 10 Mbyte dahi benim için büyük bir alan.</p><p><code>max_size</code> ise adı üzerinde, cache dosyalarının belirtilen dizin içerisinde kaplayabileceği maksimum disk alanı.</p><p><code>inactive</code> ise bir pasif cache anahtarının maksimum süresini belirtiyor. Eğer cache edilmiş bir dosyaya, bu süre zarfında hiç erişilmemiş ise, cache durumu ne olursa olsun NGINX silecektir.</p><p><code>proxy_cache_key</code>, keys_zone içerisinde tutulacak anahtarları isimlendirmek için bir şablon. Bu yönerge bir çok amaç için kullanılabilir. Eğer responsive bir web  uygulaması kullanmıyorsanız, mobil ve masa üstü istemcileri için farklı cacheler üretebilirsiniz.</p><p>Ve son olarak <code>proxy_cache_methods</code> ise istediğim <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods?ref=localhost">HTTP istek metodlarını</a> cache için seçmeme yardımcı oluyor.</p><p>Devamında artık cache yapmak istediğim ve cache dışında tutmak istediğim lokasyonları belirleyip yayınlamaya başlayabilirim. </p><pre><code class="language-nginx">location / {
            proxy_hide_header x-powered-by;
            proxy_hide_header Etag;
            proxy_redirect off;

            proxy_pass http://ghost:2368;

            proxy_cache ghost_cache;
            proxy_cache_valid 200 60m;
            proxy_cache_valid 404 3m;
            proxy_cache_revalidate off;
            proxy_ignore_headers X-Accel-Expires Expires Cache-Control;
            add_header X-NGINX-Cache $upstream_cache_status;
        }</code></pre><p>Tek tek parametreleri tanıtmak ve anlatmak istemiyorum o nedenlen buradan sonrasını biraz daha hızlı devam edeceğim. <code>location /</code> Hemen her yeri kapsayan bir cache tanımı oldu. <code>HTTP 200</code> 60 dakika boyunca, <code>HTTP 404</code> ise 3 dakika boyunca cache olacak. Bir takım HTTP başlıklarını gizlemeyi tercih ettim.</p><p>Buraya gelen tüm istekler, eğer <code>keys_zone</code> içerisinde değilse <code>proxy_pass</code> marifetiyle ghost ismine sahip containera gidecek. Son olarak da bir belirleyici ekledim ki cache işe yarıyor mu görebileyim. </p><p>Önemli iki alan var ki onları cache etmemeliyim. Bunlardan biri Ghost'un yönetim ara yüzü, diğeri ise gönderileri ön izleme yapmama yarayan alan. Aşağıdaki kontekst işime yarayacaktır.</p><pre><code class="language-nginx">location ~* ^(/ghost/|/p/) {
            proxy_hide_header x-powered-by;
            proxy_hide_header Etag;
            proxy_redirect off;

            proxy_pass http://ghost:2368;
            break;
        }</code></pre><p>Şimdi bunları bir araya getirip ilk testlere başlayayım. Testlerimde <code>curl</code> ve <code><a href="https://github.com/davecheney/httpstat?ref=localhost">httpstat</a></code> kullanacağım ve konfigürasyonum şu şekilde görünecek.</p><pre><code class="language-nginx">proxy_cache_path /var/cache/nginx/ levels=1:2 keys_zone=ghost_cache:75m max_size=512m inactive=2h;
proxy_cache_key "$request_method$host$request_uri";
proxy_cache_methods GET HEAD;

server {
    listen 80;

    location ~* ^(/ghost/|/p/) {
        proxy_hide_header x-powered-by;
        proxy_hide_header Etag;
        proxy_redirect off;

        proxy_pass http://ghost:2368;
        break;
    }

    location / {
        proxy_hide_header x-powered-by;
        proxy_hide_header Etag;
        proxy_redirect off;

        proxy_pass http://ghost:2368;

        proxy_cache ghost_cache;
        proxy_cache_valid 200 60m;
        proxy_cache_valid 404 3m;
        proxy_cache_revalidate off;
        proxy_ignore_headers X-Accel-Expires Expires Cache-Control;
        add_header X-NGINX-Cache $upstream_cache_status;
    }
}</code></pre><p>İlk olarak Ghost'u direk erişim ile test edeceğim. Söylediğim gibi aslında Ghost oldukça hızlı çalışan bir içerik yönetim sistemi.</p><pre><code class="language-plaintext">➜ httpstat https://www.gokhangeyik.net
Connected to ::1:2368 from ::1:56947

HTTP/1.1 200 OK
X-Powered-By: Express
Cache-Control: public, max-age=0
Content-Type: text/html; charset=utf-8
Content-Length: 29518
ETag: W/"734e-7qGhBLEw4KHXjVrEObfphnPgXMc"
Vary: Accept-Encoding
Date: Sun, 10 Jan 2021 10:14:37 GMT
Connection: keep-alive
Keep-Alive: timeout=5

  DNS Lookup   TCP Connection   Server Processing   Content Transfer
[     1ms    |       0ms      |       57ms        |        1ms       ]
             |                |                   |                  |
    namelookup:1ms            |                   |                  |
                        connect:1ms               |                  |
                                      starttransfer:58ms             |
                                                                 total:59ms</code></pre><p>Test blogunun ana sayfası 58ms içerisinde erişilir hale geldi. Bu oldukça iyi. Tabi <code>httpstat</code> maalesef javascript çalıştırmıyor. Bu süre reel değil. Yalnızca çıkarım yapmama yardım edecek.</p><p>Şimdi aynı isteği NGINX proxy üzerinden yapacağım. İlk isteğim cache edilmemiş olacağından 58ms'den daha uzun olma ihtimali var.</p><pre><code class="language-plaintext">➜ httpstat http://localhost
Connected to ::1:80 from ::1:57112

HTTP/1.1 200 OK
Server: nginx
Date: Sun, 10 Jan 2021 10:19:06 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 29532
Connection: keep-alive
Cache-Control: public, max-age=0
Vary: Accept-Encoding
X-NGINX-Cache: MISS

  DNS Lookup   TCP Connection   Server Processing   Content Transfer
[     2ms    |       0ms      |       68ms        |        0ms       ]
             |                |                   |                  |
    namelookup:2ms            |                   |                  |
                        connect:2ms               |                  |
                                      starttransfer:70ms             |
                                                                 total:70ms</code></pre><p>Beklediğim gibi oldu ve gayet makul. İlk istek 70ms kadar sürdü ve <code>X-NGINX-Cache: MISS</code> headerı henüz cache edilmediğini gösteriyor. Bundan sonraki isteğim direk olarak NGINX cache olacak ve arada ciddi bir hız farkı olmasını bekliyorum.</p><pre><code class="language-plaintext">➜ httpstat http://localhost
Connected to ::1:80 from ::1:57190

HTTP/1.1 200 OK
Server: nginx
Date: Sun, 10 Jan 2021 10:21:21 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 29532
Connection: keep-alive
Cache-Control: public, max-age=0
Vary: Accept-Encoding
X-NGINX-Cache: HIT

  DNS Lookup   TCP Connection   Server Processing   Content Transfer
[     1ms    |       0ms      |        3ms        |        0ms       ]
             |                |                   |                  |
    namelookup:1ms            |                   |                  |
                        connect:1ms               |                  |
                                      starttransfer:4ms              |
                                                                 total:4ms</code></pre><p>Toplam süre 4ms. Mükemmel bir sonuç. <code>X-NGINX-Cache: HIT</code> Artık cevabın Ghost'tan değil NGINX'ten geldiğini biliyorum.Öte yandan artık Ghost'u dert etmek zorunda değilim. Cache olduğu müddetçe, yüksek bir trafik ile karşılaşmayacak.</p><p>Şimdi sıra bu cache içeriğini temizlemekte. İştiyorum ki sitemde bir değişiklik yaptığımda, bu cache tamamen silinsin ve ben de değişiklikleri görebileyim. Bunun için iki şeye ihtiyacım var.</p><ol><li>NGINX purge lokasyonu</li><li>Ghost içerisinde bunu tetikleyebilecek bir mekanizma.</li></ol><p>Bunların hepsine sahibim. NGINX konfigürasyonumu aşağıdaki şekilde güncelliyorum.</p><pre><code class="language-nginx">proxy_cache_path /var/cache/nginx/ levels=1:2 keys_zone=ghost_cache:75m max_size=512m inactive=2h;
proxy_cache_key "$request_method$host$request_uri";
proxy_cache_methods GET HEAD;

server {
    listen 80;

    location ~* ^(/ghost/|/p/) {
        proxy_hide_header x-powered-by;
        proxy_hide_header Etag;
        proxy_redirect off;

        proxy_pass http://ghost:2368;
        break;
    }

    location / {
        proxy_hide_header x-powered-by;
        proxy_hide_header Etag;
        proxy_redirect off;

        proxy_pass http://ghost:2368;

        proxy_cache ghost_cache;
        proxy_cache_valid 200 60m;
        proxy_cache_valid 404 3m;
        proxy_cache_revalidate off;
        proxy_ignore_headers X-Accel-Expires Expires Cache-Control;
        add_header X-NGINX-Cache $upstream_cache_status;
    }
location /purgethecache {
        content_by_lua_block {
            os.execute("/bin/rm -rf /var/cache/nginx/*")
        }
    }
}</code></pre><p><code>purgethecache</code> isminde bir lokasyon ekledim ve oldukça basit bir lua direktifi çalıştırıyorum. Buraya gelen her istek ile birlikte <code>/var/cache/nginx</code> dizininin içeriği temizlenecek ve böylece cache yok edilmiş olacak.</p><p>Her Ghost blog bir yönetim arayüzüne sahip. Bu arayüzde <code>Integrations</code> bölümü mevcut. Bu bölümden bir <code>Custom Integration</code> ekleyeceğim.</p><figure class="kg-card kg-image-card kg-width-wide kg-card-hascaption"><img src="https://www.gokhangeyik.net/content/images/2021/01/Ghost-Custom-Integrations.jpg" class="kg-image" alt="Ghost Custom Integration Screen" loading="lazy" width="2000" height="1146" srcset="https://www.gokhangeyik.net/content/images/size/w600/2021/01/Ghost-Custom-Integrations.jpg 600w, https://www.gokhangeyik.net/content/images/size/w1000/2021/01/Ghost-Custom-Integrations.jpg 1000w, https://www.gokhangeyik.net/content/images/size/w1600/2021/01/Ghost-Custom-Integrations.jpg 1600w, https://www.gokhangeyik.net/content/images/size/w2400/2021/01/Ghost-Custom-Integrations.jpg 2400w" sizes="(min-width: 1200px) 1200px"><figcaption>Ghost Custom Integrations</figcaption></figure><p>Şimdi de bu entegrasyona bir Webhook ekleyeceğim. Yani Ghost, sitede herhangi bir değişiklik olunca, gidip <code>purgethecache</code> lokasyonunu ziyaret edecek. NGINX de tanımlandığı gibi cache içeriğini silecek.</p><figure class="kg-card kg-image-card kg-width-wide kg-card-hascaption"><img src="https://www.gokhangeyik.net/content/images/2021/01/Ghost-Webhook.jpg" class="kg-image" alt="Ghost Webhook" loading="lazy" width="2000" height="1145" srcset="https://www.gokhangeyik.net/content/images/size/w600/2021/01/Ghost-Webhook.jpg 600w, https://www.gokhangeyik.net/content/images/size/w1000/2021/01/Ghost-Webhook.jpg 1000w, https://www.gokhangeyik.net/content/images/size/w1600/2021/01/Ghost-Webhook.jpg 1600w, https://www.gokhangeyik.net/content/images/size/w2400/2021/01/Ghost-Webhook.jpg 2400w" sizes="(min-width: 1200px) 1200px"><figcaption>Ghost Webhook</figcaption></figure><p>Hedefime ulaştım. Artık calışan bir cache mekanizmam ve purge mekanizmam mevcut. Bu konfigurasyon elbette geliştiriebilir ve ben elimden geldiğince sadeleştirerek anlatmak istedim.</p><p></p>
                </div>
            </section>

                     <div>
             <script>
                function sharePopup(type, width, height) {
                    var left = (screen.width / 2) - (width / 2),
                        top = (screen.height / 2) - (height / 2),
                        social_url,
                        social_title;

                    if (type == "twitter") {
                        social_url = "https://www.gokhangeyik.net/ghost-ve-nginx-proxy-cache/";
                        social_title = "Ghost%20ve%20NGINX%20Proxy%20Cache";
                        url = "https://twitter.com/share?url=" + social_url + "&text=" + social_title + "&via=gokhangeyiknet";
                    }
                    if (type == "facebook") {
                        social_url = "https://www.gokhangeyik.net/ghost-ve-nginx-proxy-cache/";
                        url = "https://www.facebook.com/sharer.php?u=" + social_url;
                    }
                    if (type == "linkedin") {
                        social_url = "https://www.gokhangeyik.net/ghost-ve-nginx-proxy-cache/";
                        social_title = "Ghost%20ve%20NGINX%20Proxy%20Cache";
                        url = "https://www.linkedin.com/shareArticle?mini=true&url=" + social_url;
                    }
                    window.open(
                        url,
                        "",
                        "menubar=no,toolbar=no,resizable=yes,scrollbars=yes,width=" + width + ",height=" + height + ",top=" + top + ",left=" + left
                    );
                }
             </script>
            <div class="gg-social-share">
                <h5>Bu İçeriği Paylaşın</h5>
                <span class="gg-facebook" onclick="sharePopup('facebook', 500, 300)"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!-- Font Awesome Free 5.15.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M279.14 288l14.22-92.66h-88.91v-60.13c0-25.35 12.42-50.06 52.24-50.06h40.42V6.26S260.43 0 225.36 0c-73.22 0-121.08 44.38-121.08 124.72v70.62H22.89V288h81.39v224h100.17V288z"/></svg></span>
                <span class="gg-twitter" onclick="sharePopup('twitter', 500, 300)"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg></span>
                <span class="gg-linkedin" onclick="sharePopup('linkedin', 500,420)"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M100.28 448H7.4V148.9h92.88zM53.79 108.1C24.09 108.1 0 83.5 0 53.8a53.79 53.79 0 0 1 107.58 0c0 29.7-24.1 54.3-53.79 54.3zM447.9 448h-92.68V302.4c0-34.7-.7-79.2-48.29-79.2-48.29 0-55.69 37.7-55.69 76.7V448h-92.78V148.9h89.08v40.8h1.3c12.4-23.5 42.69-48.3 87.88-48.3 94 0 111.28 61.9 111.28 142.3V448z"/></svg></span>
            </div>
        </div>
        <br/>
        <section class="post-full-comments">
            <div id="disqus_thread"></div>
            <script type="text/javascript">
                var disqus_shortname = "gokhangeyik";
                var disqus_url = "https://www.gokhangeyik.net/ghost-ve-nginx-proxy-cache/";
                var disqus_identifier = "ghost-5ff3a6d08e33d80001053643";
                var disqus_loaded = false;
                function disqus() {
                    if (!disqus_loaded) {
                        disqus_loaded = true;
                        var e = document.createElement("script");
                        e.type = "text/javascript";
                        e.async = true;
                        e.src = "//" + disqus_shortname + ".disqus.com/embed.js";
                        (document.getElementsByTagName("head")[0] ||
                        document.getElementsByTagName("body")[0])
                        .appendChild(e);
                    }
                }
            </script>
        </section>
        </article>
    </div>
</main>

<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">


                <article class="post-card post tag-hayat tag-is-hayati tag-almanya featured ">

    <a class="post-card-image-link" href="/almanyada-bilisimci-olmak/">
        <img class="post-card-image"
            srcset="/content/images/size/w300/2021/01/Mountain-Landscape.jpg 300w,
                    /content/images/size/w600/2021/01/Mountain-Landscape.jpg 600w,
                    /content/images/size/w1000/2021/01/Mountain-Landscape.jpg 1000w,
                    /content/images/size/w2000/2021/01/Mountain-Landscape.jpg 2000w"
            sizes="(max-width: 1000px) 400px, 700px"
            loading="lazy"
            src="/content/images/size/w300/2021/01/Mountain-Landscape.jpg"
            alt="Almanya&#x27;da Bilişimci Olmak"
        />
    </a>

    <div class="post-card-content">

        <a class="post-card-content-link" href="/almanyada-bilisimci-olmak/">

            <header class="post-card-header">
                    <div class="post-card-primary-tag">Hayat</div>
                <h2 class="post-card-title">Almanya&#x27;da Bilişimci Olmak</h2>
            </header>

            <section class="post-card-excerpt">
                    <p>Türkiye'de birçok bilişim çalışanının aklının bir köşesinde, yeteneklerini yurt dışında değerlendirmek olduğunu biliyorum. Ancak sayısız gerekçelerle bunu erteliyoruz.</p>
            </section>

        </a>

        <footer class="post-card-meta">
            <ul class="author-list">
                <li class="author-list-item">
            
                    <div class="author-name-tooltip">
                        Gökhan Geyik
                    </div>
            
                    <a href="/author/gokko/" class="static-avatar">
                        <img class="author-profile-image" src="/content/images/size/w100/2021/01/pp.jpg" alt="Gökhan Geyik"/>
                    </a>
                </li>
            </ul>
            <div class="post-card-byline-content">
                <span><a href="/author/gokko/">Gökhan Geyik</a></span>
                <span class="post-card-byline-date"><time datetime="2020-08-19">19 Ağustos 2020 19:44</time> <span class="bull"></span>
            </div>
        </footer>

    </div>

</article>
        </div>
    </div>
</aside>




        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="https://www.gokhangeyik.net">Gökhan Geyik | Sistem Yöneticisi Bir Bey!</a> &copy; 2023</section>
                <nav class="site-footer-nav">
                    <a href="https://www.gokhangeyik.net">Latest Posts</a>
                    <a href="https://www.facebook.com/gokhangeyik.net" target="_blank" rel="noopener">Facebook</a>
                    <a href="https://twitter.com/gokhangeyiknet" target="_blank" rel="noopener">Twitter</a>
                    <a href="https://www.linkedin.com/in/gokhangeyik/" title="Linkedin" target="_blank" rel="noopener">Linkedin</a>
                </nav>
            </div>
        </footer>

    </div>


    <script src="/assets/js/extra/jquery-3.5.1.min.js?v=d315fa5c26"></script>
    <script src="/assets/built/casper.js?v=d315fa5c26"></script>

    <script>
        // Parse the URL parameter
        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        // Give the parameter a variable name
        var action = getParameterByName('action');
        var success = getParameterByName('success');

        $(document).ready(function () {
            if (action == 'subscribe' && (success === null || success === 'true')) {
                $('body').addClass('subscribe-success');
            }

            if (action == 'subscribe' && success === 'false') {
                $('body').addClass('subscribe-failure');
            }

            $('.subscribe-notification .subscribe-close-button').click(function () {
                $('.subscribe-notification').addClass('close');
            });

            // Reset form on opening subscrion overlay
            $('.subscribe-button').click(function() {
                $('.subscribe-overlay form').removeClass();
                $('.subscribe-email').val('');
            });
        });
    </script>

    <script>
    $(document).ready(function () {
        // FitVids - start
        var $postContent = $(".post-full-content");
        $postContent.fitVids();
        // FitVids - end

        // Replace nav with title on scroll - start
        Casper.stickyNavTitle({
            navSelector: '.site-nav-main',
            titleSelector: '.post-full-title',
            activeClass: 'nav-post-title-active'
        });
        // Replace nav with title on scroll - end

        // Hover on avatar
        var hoverTimeout;
        $('.author-list-item').hover(function () {
            var $this = $(this);

            clearTimeout(hoverTimeout);

            $('.author-card').removeClass('hovered');
            $(this).children('.author-card').addClass('hovered');

        }, function () {
            var $this = $(this);

            hoverTimeout = setTimeout(function () {
                $this.children('.author-card').removeClass('hovered');
            }, 800);
        });
    });
    /*window.onload = () => {
        const post = document.getElementsByTagName('article')[0];
        const progressBar = document.getElementById('progress-bar');
        const distance = (post.clientHeight + post.offsetTop) - window.innerHeight;

        window.addEventListener('scroll', () => {
        const progress = window.scrollY / distance * 100;
        progressBar.style.width = `${progress}%`;
        });
    }*/
    window.onscroll = function(e) {
        article = document.getElementById("site-main");
        if ((window.innerHeight + window.scrollY) >= (article.clientHeight - 200))
            {
                if (!disqus_loaded) disqus();
            }
    };
</script>
<script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script>
<script>
    mediumZoom('.post-content .kg-image-card img', { background: '#111' });
    mediumZoom('.post-content .kg-gallery-card img', { background: '#111' });
</script>


    <script src="/assets/js/extra/webfont.js?v=d315fa5c26"></script>
    <script defer>
        WebFont.load ({
            custom: {
                families: ['Merriweather', 'Barlow', 'Roboto Mono'],
                urls: ['https://www.gokhangeyik.net/assets/built/fonts.css?v=d315fa5c26']
            }
        });
        $('a').each(function() {
            var a = new RegExp('/' + window.location.host + '/');
            if(!a.test(this.href)) {
                $(this).click(function(event) {
                    event.preventDefault();
                    event.stopPropagation();
                    window.open(this.href, '_blank');
                });
            }
            });
    </script>
    

</body>
</html>
